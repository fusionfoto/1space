# I am intended to be built from the top of the swift-s3-sync tree like this:
#    docker build [...] -f test/container/Dockerfile .

FROM bouncestorage/swift-aio:latest

COPY requirements.txt requirements-test.txt test/container/*.patch /tmp/

RUN apt-get update && \
    apt-get install --no-install-recommends -y \
        wget curl patch git build-essential python-dev locales \
        openjdk-8-jre-headless net-tools && \
    apt-get clean && \
    pip install -U -r /tmp/requirements.txt -r /tmp/requirements-test.txt && \
    pip uninstall -y hacking && \
    mkdir -p /s3proxy/data && \
    cd /s3proxy && \
    wget https://github.com/andrewgaul/s3proxy/releases/download/s3proxy-1.5.3/s3proxy && \
    bash -c "cd /usr/local/src \
    && patch -p0 < /tmp/tempauth.patch \
    && rm -f /tmp/tempauth.patch" && \
    bash -c "cd /usr/local/src \
    && patch -p0 < /tmp/swiftclient.patch \
    && rm -f /tmp/swiftclient.patch" && \
    bash -c "cd /usr/local/src \
    && patch -p0 < /tmp/swift3-unicode-fix.patch \
    && rm -f /tmp/swift3-unicode-fix.patch" && \
    mkdir /swift-s3-sync && mkdir /var/lib/swift-s3-sync && \
    locale-gen en_US.UTF-8

EXPOSE 10080
ENV LANG='en_US.UTF-8' LANGUAGE='en_US:en' LC_ALL='en_US.UTF-8' \
    CONF_BUCKET=cloud-connector-conf

CMD ["/bin/bash", "/swift-s3-sync/test/container/launch.sh"]
